<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Prime Number Shooter 3D</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Bangers', 'Noto Sans TC', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; 
            overscroll-behavior: none;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            touch-action: none;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            text-shadow: 2px 2px 0 #000;
        }

        /* HUD */
        #score-display {
            position: absolute;
            top: 10px;
            left: 20px;
            color: #ffd700;
            font-size: 1.8rem;
        }

        #best-score-display {
            position: absolute;
            top: 50px;
            left: 20px;
            font-size: 1.2rem;
            color: #aaa;
        }

        #lives-display {
            position: absolute;
            top: 10px;
            right: 20px;
            text-align: right;
            font-size: 1.5rem;
            color: white;
        }

        #lives-icons {
            color: #ff4444;
            letter-spacing: 5px;
        }

        #timer-display {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            font-size: 4rem;
            display: none;
            color: #fff;
        }

        #message-display {
            position: absolute;
            top: 30%;
            width: 100%;
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        /* Menu Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 20;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 4rem;
            color: #6bff89;
            margin-bottom: 10px;
            margin-top: 0;
            text-align: center;
            line-height: 1.2;
            text-shadow: 0 0 10px #00ff00;
        }

        .menu-btn {
            font-family: 'Bangers', 'Noto Sans TC', sans-serif;
            font-size: 1.8rem;
            padding: 15px 40px;
            margin: 10px;
            width: 280px;
            background: linear-gradient(45deg, #2193b0, #6dd5ed);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50px;
            transition: transform 0.1s, filter 0.1s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-shadow: 1px 1px 0 #000;
        }

        .menu-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
        }

        .menu-btn:active {
            transform: scale(0.95);
        }

        .instruction-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 20px;
            max-width: 600px;
            color: #ddd;
            font-family: 'Noto Sans TC', sans-serif;
            text-align: left;
            line-height: 1.6;
            font-size: 1rem;
        }
        
        .instruction-box h3 {
            color: #ffd700;
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 1.3rem;
        }
        
        .highlight {
            color: #6bff89;
            font-weight: bold;
        }
        
        .bad {
            color: #ff4444;
            font-weight: bold;
        }

    </style>
    <!-- Import Three.js from CDN -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="score-display">åˆ†æ•¸: <span id="score-val">0</span></div>
        <div id="best-score-display">æœ€é«˜åˆ†: <span id="best-val">0</span></div>
        <div id="lives-display">ç”Ÿå‘½å€¼<br><span id="lives-icons">â¤ï¸â¤ï¸â¤ï¸</span></div>
        <div id="timer-display">60</div>
        <div id="message-display">PRIME! +5</div>
    </div>

    <!-- Main Menu -->
    <div id="start-screen" class="screen">
        <h1>MATH SHOOTER<br><span style="font-size: 2rem; color: #fff;">(è³ªæ•¸å°„æ“Šæ‰‹)</span></h1>
        
        <button class="menu-btn" onclick="gameApp.startGame('classic')">é–‹å§‹éŠæˆ² (Start)</button>
        <button class="menu-btn" onclick="gameApp.startGame('time')">è¨ˆæ™‚æŒ‘æˆ° (Time Attack)</button>
        
        <div class="instruction-box">
            <h3>ğŸ¯ éŠæˆ²ç©æ³•èªªæ˜</h3>
            <ul>
                <li><strong>æ“ä½œæ–¹å¼ï¼š</strong>æ»‘å‹•æ»‘é¼ æˆ–æ‰‹æŒ‡æ§åˆ¶ä¸‹æ–¹ç ²å°è§’åº¦ï¼Œ<strong>é»æ“Š</strong>ç™¼å°„å­å½ˆã€‚</li>
                <li><strong>ç›®æ¨™ï¼š</strong>æ°´æœæœƒå¸¶è‘—æ•¸å­—å¾ä¸Šæ–¹æ‰è½ã€‚</li>
                <li><strong>è¦å‰‡ï¼š</strong>
                    <ul>
                        <li>å°„ä¸­ <span class="highlight">è³ªæ•¸ (2, 3, 5, 7, 11...)</span>ï¼š<span class="highlight">åŠ åˆ†</span>ï¼</li>
                        <li>å°„ä¸­ <span class="bad">éè³ªæ•¸ (4, 6, 8, 9, 10...)</span>ï¼š<span class="bad">æ‰£åˆ†ä¸¦æ‰£è¡€</span>ï¼</li>
                        <li>æ°´æœæ‰åˆ°åº•éƒ¨ï¼šä¸æ‰£åˆ†ï¼Œä½†æœƒå¤±å»å°„æ“Šæ©Ÿæœƒã€‚</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: #ff4444; text-shadow: none;">GAME OVER</h1>
        <h2 style="color:white; font-size: 3rem;">æœ€çµ‚åˆ†æ•¸: <span id="final-score">0</span></h2>
        <button class="menu-btn" onclick="gameApp.restartGame()">å†ç©ä¸€æ¬¡</button>
        <button class="menu-btn" onclick="gameApp.showMenu()">å›ä¸»é¸å–®</button>
    </div>

<script type="module">
import * as THREE from 'three';

/**
 * è³ªæ•¸æª¢æŸ¥å·¥å…·
 */
function isPrime(num) {
    if (num <= 1) return false;
    if (num <= 3) return true;
    if (num % 2 === 0 || num % 3 === 0) return false;
    for (let i = 5; i * i <= num; i += 6) {
        if (num % i === 0 || num % (i + 2) === 0) return false;
    }
    return true;
}

class SoundManager {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.value = 0.3;
        this.masterGain.connect(this.ctx.destination);
        this.enabled = true;
    }

    playShoot() {
        if (!this.enabled || this.ctx.state === 'suspended') return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, this.ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.15);
    }

    playCorrect() {
        if (!this.enabled || this.ctx.state === 'suspended') return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(600, this.ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(1200, this.ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.3);
    }

    playWrong() {
        if (!this.enabled || this.ctx.state === 'suspended') return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, this.ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(50, this.ctx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
        osc.connect(gain);
        gain.connect(this.masterGain);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.4);
    }
}

class ParticleSystem {
    constructor(scene) {
        this.scene = scene;
        this.particles = [];
        this.geo = new THREE.BoxGeometry(0.15, 0.15, 0.15);
    }

    emit(position, color, count = 10) {
        const mat = new THREE.MeshPhongMaterial({ color: color, shininess: 100 });
        
        for(let i=0; i<count; i++) {
            const mesh = new THREE.Mesh(this.geo, mat);
            mesh.position.copy(position);
            mesh.userData = {
                velocity: new THREE.Vector3(
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10
                ),
                life: 1.0,
                rotSpeed: new THREE.Vector3(Math.random(), Math.random(), Math.random())
            };
            this.scene.add(mesh);
            this.particles.push(mesh);
        }
    }

    update(dt) {
        for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];
            p.position.add(p.userData.velocity.clone().multiplyScalar(dt));
            p.rotation.x += p.userData.rotSpeed.x * 0.1;
            p.rotation.y += p.userData.rotSpeed.y * 0.1;
            p.userData.life -= dt * 2; // Fade fast
            p.scale.setScalar(p.userData.life);

            if (p.userData.life <= 0) {
                this.scene.remove(p);
                this.particles.splice(i, 1);
            }
        }
    }
}

class Shooter {
    constructor(scene) {
        this.scene = scene;
        this.group = new THREE.Group();
        this.angle = 0;

        // Base
        const baseGeo = new THREE.CylinderGeometry(1, 1, 0.5, 32);
        const baseMat = new THREE.MeshPhongMaterial({ color: 0x555555 });
        const base = new THREE.Mesh(baseGeo, baseMat);
        base.rotation.x = Math.PI / 2;
        this.group.add(base);

        // Turret
        this.turret = new THREE.Group();
        
        const barrelGeo = new THREE.CylinderGeometry(0.2, 0.3, 2, 16);
        const barrelMat = new THREE.MeshPhongMaterial({ color: 0x22aaff });
        const barrel = new THREE.Mesh(barrelGeo, barrelMat);
        barrel.position.y = 1; // Offset so it rotates from bottom
        this.turret.add(barrel);
        
        this.group.add(this.turret);
        
        // Position at bottom center
        this.group.position.set(0, -12, 0);
        this.scene.add(this.group);
    }

    update(mouseXNorm) {
        // Map mouse X (-1 to 1) to angle (-90 deg to 90 deg approx)
        // -1 -> 90 deg (Left), 1 -> -90 deg (Right) in ThreeJS Z-rotation terms
        // We want to rotate around Z axis since camera is looking at XY plane
        
        // Clamp logic
        const maxAngle = Math.PI / 2.2; // Slightly less than 90 degrees
        this.angle = -mouseXNorm * maxAngle; 
        this.turret.rotation.z = this.angle;
    }

    getTipPosition() {
        // Calculate where the bullet spawns (tip of barrel)
        const vec = new THREE.Vector3(0, 2, 0);
        vec.applyEuler(this.turret.rotation);
        vec.add(this.group.position);
        return vec;
    }

    getDirection() {
        const vec = new THREE.Vector3(0, 1, 0);
        vec.applyEuler(this.turret.rotation);
        return vec.normalize();
    }
}

class Bullet {
    constructor(scene, position, direction) {
        this.scene = scene;
        this.active = true;
        this.speed = 25;
        this.direction = direction;
        
        const geo = new THREE.SphereGeometry(0.3, 8, 8);
        const mat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
        this.mesh = new THREE.Mesh(geo, mat);
        this.mesh.position.copy(position);
        this.scene.add(this.mesh);
    }

    update(dt) {
        if (!this.active) return;
        this.mesh.position.add(this.direction.clone().multiplyScalar(this.speed * dt));
        
        // Bounds check
        if (this.mesh.position.y > 15 || this.mesh.position.x < -15 || this.mesh.position.x > 15) {
            this.destroy();
        }
    }

    destroy() {
        this.active = false;
        this.scene.remove(this.mesh);
    }
}

class FallingObject {
    constructor(scene) {
        this.scene = scene;
        this.active = true;
        this.group = new THREE.Group();
        
        // Random number 2-99
        this.number = Math.floor(Math.random() * 98) + 2;
        this.isPrime = isPrime(this.number);

        // Create Fruit Mesh
        const types = ['watermelon', 'apple', 'orange'];
        const type = types[Math.floor(Math.random() * types.length)];
        let color = 0xff0000;
        let geo;

        if (type === 'watermelon') {
            color = 0x2e8b57;
            geo = new THREE.SphereGeometry(1, 16, 16);
        } else if (type === 'apple') {
            color = 0xff4444;
            geo = new THREE.SphereGeometry(0.8, 16, 16);
        } else {
            color = 0xffa500;
            geo = new THREE.SphereGeometry(0.9, 16, 16);
        }

        const mesh = new THREE.Mesh(geo, new THREE.MeshPhongMaterial({ color: color }));
        this.group.add(mesh);

        // Create Number Text Sprite
        const textTexture = this.createNumberTexture(this.number);
        const spriteMat = new THREE.SpriteMaterial({ map: textTexture });
        const sprite = new THREE.Sprite(spriteMat);
        sprite.scale.set(1.5, 1.5, 1);
        sprite.position.z = 1.1; // In front of fruit
        this.group.add(sprite);

        // Position
        const xPos = (Math.random() - 0.5) * 16; // Wider range
        this.group.position.set(xPos, 15, 0); // Start at top
        
        // Physics
        this.speed = 3 + Math.random() * 4; // Downward speed
        this.rotSpeed = (Math.random() - 0.5) * 2;

        this.scene.add(this.group);
    }

    createNumberTexture(num) {
        const canvas = document.createElement('canvas');
        canvas.width = 128;
        canvas.height = 128;
        const ctx = canvas.getContext('2d');
        ctx.font = 'bold 80px Arial';
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = 'black';
        ctx.shadowBlur = 4;
        ctx.fillText(num, 64, 64);
        
        const tex = new THREE.CanvasTexture(canvas);
        return tex;
    }

    update(dt) {
        if (!this.active) return;

        this.group.position.y -= this.speed * dt;
        this.group.rotation.z += this.rotSpeed * dt;

        if (this.group.position.y < -15) {
            this.active = false;
            this.scene.remove(this.group);
        }
    }

    destroy() {
        this.active = false;
        this.scene.remove(this.group);
    }
}

class GameApp {
    constructor() {
        this.initThree();
        this.clock = new THREE.Clock();
        this.audio = new SoundManager();
        this.particles = new ParticleSystem(this.scene);
        this.shooter = new Shooter(this.scene);

        this.bullets = [];
        this.targets = [];
        
        this.score = 0;
        this.lives = 3;
        this.bestScore = localStorage.getItem('primeShooterBest') || 0;
        this.mode = 'menu'; 
        this.spawnTimer = 0;

        this.ui = {
            score: document.getElementById('score-val'),
            best: document.getElementById('best-val'),
            lives: document.getElementById('lives-icons'),
            livesContainer: document.getElementById('lives-display'),
            timer: document.getElementById('timer-display'),
            message: document.getElementById('message-display'),
            startScreen: document.getElementById('start-screen'),
            gameOverScreen: document.getElementById('game-over-screen'),
            finalScore: document.getElementById('final-score')
        };
        
        this.mouseNormX = 0;
        this.setupInput();
        this.updateUI();
        this.animate();
    }

    initThree() {
        this.container = document.getElementById('canvas-container');
        this.scene = new THREE.Scene();
        
        this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        this.camera.position.set(0, 0, 25); // Further back
        this.camera.lookAt(0, 0, 0);

        this.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        this.container.appendChild(this.renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        this.scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(5, 10, 7);
        this.scene.add(dirLight);
    }

    setupInput() {
        window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth / window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
        });

        const handleMove = (clientX) => {
            // Map 0->width to -1->1
            this.mouseNormX = (clientX / window.innerWidth) * 2 - 1;
        };

        const handleShoot = () => {
            if (this.mode !== 'playing') return;
            this.audio.ctx.resume();
            
            const pos = this.shooter.getTipPosition();
            const dir = this.shooter.getDirection();
            
            this.bullets.push(new Bullet(this.scene, pos, dir));
            this.audio.playShoot();
        };

        // Mouse
        document.addEventListener('mousemove', e => handleMove(e.clientX));
        document.addEventListener('mousedown', handleShoot);

        // Touch
        this.container.addEventListener('touchmove', e => {
            e.preventDefault();
            handleMove(e.touches[0].clientX);
        }, {passive: false});
        this.container.addEventListener('touchstart', e => {
            e.preventDefault();
            handleMove(e.touches[0].clientX);
            handleShoot();
        }, {passive: false});
    }

    startGame(mode) {
        this.mode = 'playing';
        this.gameModeType = mode;
        this.score = 0;
        this.lives = 3;
        this.gameTime = 0;
        this.spawnTimer = 0;
        
        // Cleanup
        this.targets.forEach(t => t.destroy());
        this.bullets.forEach(b => b.destroy());
        this.targets = [];
        this.bullets = [];

        this.ui.startScreen.classList.add('hidden');
        this.ui.gameOverScreen.classList.add('hidden');
        
        if (mode === 'time') {
            this.timeLeft = 60;
            this.ui.timer.style.display = 'block';
            this.ui.livesContainer.style.display = 'none';
        } else {
            this.ui.timer.style.display = 'none';
            this.ui.livesContainer.style.display = 'block';
        }

        this.updateUI();
    }

    showMenu() {
        this.mode = 'menu';
        this.ui.startScreen.classList.remove('hidden');
        this.ui.gameOverScreen.classList.add('hidden');
    }

    restartGame() {
        this.startGame(this.gameModeType);
    }

    showMessage(text, color) {
        const el = this.ui.message;
        el.innerText = text;
        el.style.color = color;
        el.style.opacity = 1;
        el.style.top = '30%';
        
        // Float up animation reset
        setTimeout(() => {
            el.style.top = '20%';
            el.style.opacity = 0;
        }, 500);
    }

    checkCollisions() {
        // Bullet vs Target
        for (let i = this.bullets.length - 1; i >= 0; i--) {
            const b = this.bullets[i];
            let hit = false;

            for (let j = this.targets.length - 1; j >= 0; j--) {
                const t = this.targets[j];
                
                // Simple Sphere Collision (dist < radius1 + radius2)
                const dist = b.mesh.position.distanceTo(t.group.position);
                if (dist < 1.5) {
                    // Hit!
                    this.handleHit(t);
                    t.destroy();
                    this.targets.splice(j, 1);
                    hit = true;
                    break;
                }
            }

            if (hit) {
                b.destroy();
                this.bullets.splice(i, 1);
            }
        }
    }

    handleHit(target) {
        if (target.isPrime) {
            // GOOD!
            this.score += 10; // Higher score for shooting
            this.audio.playCorrect();
            this.particles.emit(target.group.position, 0x00ff00, 20);
            this.showMessage(`è³ªæ•¸! ${target.number}`, '#6bff89');
        } else {
            // BAD!
            this.audio.playWrong();
            this.particles.emit(target.group.position, 0xff0000, 20);
            this.showMessage(`éè³ªæ•¸! ${target.number}`, '#ff4444');
            
            if (this.gameModeType === 'classic') {
                this.lives--;
                if (this.lives <= 0) this.gameOver();
            } else {
                this.score = Math.max(0, this.score - 20); // Penalty for Time Attack
            }
        }
        this.updateUI();
    }

    gameOver() {
        this.mode = 'gameover';
        if (this.score > this.bestScore) {
            this.bestScore = this.score;
            localStorage.setItem('primeShooterBest', this.bestScore);
        }
        this.ui.finalScore.innerText = this.score;
        this.ui.gameOverScreen.classList.remove('hidden');
        this.updateUI();
    }

    updateUI() {
        this.ui.score.innerText = this.score;
        this.ui.best.innerText = this.bestScore;
        
        let livesStr = '';
        for(let i=0; i<this.lives; i++) livesStr += 'â¤ï¸ ';
        this.ui.lives.innerText = livesStr;
    }

    animate() {
        requestAnimationFrame(this.animate.bind(this));
        
        const dt = Math.min(this.clock.getDelta(), 0.1);
        
        // Update Shooter Angle
        this.shooter.update(this.mouseNormX);

        if (this.mode === 'playing') {
            this.spawnTimer -= dt;

            // Spawn Logic
            if (this.spawnTimer <= 0) {
                this.targets.push(new FallingObject(this.scene));
                // Decrease spawn time based on score/time
                const difficulty = Math.max(0.5, 2.0 - (this.score * 0.02));
                this.spawnTimer = difficulty;
            }

            // Update Bullets
            for (let i = this.bullets.length - 1; i >= 0; i--) {
                this.bullets[i].update(dt);
                if (!this.bullets[i].active) {
                    this.bullets.splice(i, 1);
                }
            }

            // Update Targets (Falling)
            for (let i = this.targets.length - 1; i >= 0; i--) {
                this.targets[i].update(dt);
                if (!this.targets[i].active) {
                    // Fell off screen - No penalty logic requested, just remove
                    this.targets.splice(i, 1);
                }
            }

            this.checkCollisions();
            
            // Time Attack Logic
            if (this.gameModeType === 'time') {
                this.timeLeft -= dt;
                this.ui.timer.innerText = Math.ceil(this.timeLeft);
                if (this.timeLeft <= 0) this.gameOver();
            }
        }

        this.particles.update(dt);
        this.renderer.render(this.scene, this.camera);
    }
}

window.gameApp = new GameApp();

</script>
</body>
</html>
